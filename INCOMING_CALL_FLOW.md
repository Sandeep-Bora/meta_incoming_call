# üìû Incoming Call Flow Documentation

## üéØ Overview
This document describes the complete flow for handling incoming WhatsApp calls, including all SDP (Session Description Protocol) exchanges and WebRTC bridge establishment.

## üìã Flow Summary

### 1. WhatsApp Initiates Call
- **Event**: WhatsApp sends `connect` event with SDP offer
- **Direction**: WhatsApp ‚Üí Our Server
- **SDP Type**: Offer (from WhatsApp)

### 2. Server Processing
- **Action**: Store WhatsApp SDP offer
- **Action**: Show incoming call modal to user
- **Action**: Wait for user to accept call

### 3. User Accepts Call
- **Action**: Browser starts WebRTC
- **Action**: Browser requests microphone access
- **Action**: Browser generates SDP offer

### 4. WebRTC Bridge Establishment
- **Action**: Server receives browser SDP offer
- **Action**: Server creates SDP answer for browser
- **Action**: Server creates SDP answer for WhatsApp
- **Action**: Two-way voice exchange established

## üîç Detailed SDP Analysis

### WhatsApp SDP Offer (Received)
```
v=0
o=- 1754568286961 2 IN IP4 127.0.0.1
s=-
t=0 0
a=group:BUNDLE 0
a=msid-semantic: WMS d86ef78b-6f38-420e-a817-63c8a83f127e
a=ice-lite
m=audio 3484 UDP/TLS/RTP/SAVPF 111 126
c=IN IP4 57.144.143.49
a=rtcp:9 IN IP4 0.0.0.0
a=candidate:4163951284 1 udp 2122260223 57.144.143.49 3484 typ host generation 0 network-cost 50
a=candidate:867790044 1 udp 2122262783 2a03:2880:f347:131:face:b00c:0:699c 3484 typ host generation 0 network-cost 50
a=ice-ufrag:aEFjtCCUhgCbqzPT
a=ice-pwd:OaQ0IhwUNfam/PH5Iu2ldg==
a=fingerprint:sha-256 97:52:4F:78:BA:BA:45:0E:16:6F:87:F8:0E:5F:AB:5C:39:13:31:43:D4:B7:8D:D4:54:07:4B:B1:46:49:1F:5D
a=setup:passive
a=mid:0
a=sendrecv
a=msid:d86ef78b-6f38-420e-a817-63c8a83f127e WhatsAppTrack1
a=rtcp-mux
a=rtpmap:111 opus/48000/2
a=rtcp-fb:111 transport-cc
a=fmtp:111 maxaveragebitrate=20000;maxplaybackrate=16000;minptime=20;sprop-maxcapturerate=16000;useinbandfec=1
a=rtpmap:126 telephone-event/8000
a=maxptime:20
a=ptime:20
a=ssrc:2926123515 cname:WhatsAppAudioStream1
```

**SDP Analysis:**
- **Type**: Offer (from WhatsApp)
- **Length**: 1020 characters
- **Media Sections**: 1 (audio)
- **ICE Candidates**: 2 (host candidates)
- **Codecs**: opus/48000/2, telephone-event/8000
- **Setup**: passive (WhatsApp is passive)
- **Direction**: sendrecv (bidirectional)

### Browser SDP Offer (Received)
```
v=0
o=- 1946449015237122081 2 IN IP4 127.0.0.1
s=-
t=0 0
a=group:BUNDLE 0
a=extmap-allow-mixed
a=msid-semantic: WMS 7d447a37-bc87-436c-8b94-276ed8eddd96
m=audio 9 UDP/TLS/RTP/SAVPF 111 63 9 0 8 13 110 126
c=IN IP4 0.0.0.0
a=rtcp:9 IN IP4 0.0.0.0
a=ice-ufrag:hYW4
a=ice-pwd:/cQQt8kNP1FcJiB1RtYL1U15
a=ice-options:trickle
a=fingerprint:sha-256 A1:28:B3:A3:6B:B9:08:F0:13:B6:A1:AE:61:E8:3F:13:B6:09:5D:EB:FF:71:5F:79:94:53:18:A3:03:A0:F7:E3
a=setup:actpass
a=mid:0
a=extmap:1 urn:ietf:params:rtp-hdrext:ssrc-audio-level
a=extmap:2 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time
a=extmap:3 http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01
a=extmap:4 urn:ietf:params:rtp-hdrext:sdes:mid
a=sendrecv
a=msid:7d447a37-bc87-436c-8b94-276ed8eddd96 07934d7e-aff7-4c70-9bc7-2f74061534ea
a=rtcp-mux
a=rtcp-rsize
a=rtpmap:111 opus/48000/2
a=rtcp-fb:111 transport-cc
a=fmtp:111 minptime=10;useinbandfec=1
a=rtpmap:63 red/48000/2
a=fmtp:63 111/111
a=rtpmap:9 G722/8000
a=rtpmap:0 PCMU/8000
a=rtpmap:8 PCMA/8000
a=rtpmap:13 CN/8000
a=rtpmap:110 telephone-event/48000
a=rtpmap:126 telephone-event/8000
a=ssrc:2107075907 cname:6yY4ZHY86ZIQL3xF
a=ssrc:2107075907 msid:7d447a37-bc87-436c-8b94-276ed8eddd96 07934d7e-aff7-4c70-9bc7-2f74061534ea
```

**SDP Analysis:**
- **Type**: Offer (from browser)
- **Length**: 1295 characters
- **Media Sections**: 1 (audio)
- **ICE Candidates**: 0 (trickle ICE)
- **Codecs**: opus/48000/2, red/48000/2, G722/8000, PCMU/8000, PCMA/8000, CN/8000, telephone-event/48000, telephone-event/8000
- **Setup**: actpass (browser can be active or passive)
- **Direction**: sendrecv (bidirectional)

### Browser SDP Answer (Generated by Server)
```
v=0
o=- 5812517613655811032 2 IN IP4 127.0.0.1
s=-
t=0 0
a=group:BUNDLE 0
a=extmap-allow-mixed
a=msid-semantic: WMS f3226065-a354-4e14-a1ad-12c306d9e0b0
m=audio 9 UDP/TLS/RTP/SAVPF 111 9 0 8 13 110 126
c=IN IP4 0.0.0.0
a=rtcp:9 IN IP4 0.0.0.0
a=ice-ufrag:DTEC
a=ice-pwd:VWdFZv+jFVXWerhwvgj/kmoL
a=ice-options:trickle
a=fingerprint:sha-256 29:A3:CD:CD:A7:5E:13:61:59:F7:1E:8E:E4:91:49:22:1F:4E:8C:E9:CA:FA:B1:E1:0A:B0:B1:9C:0D:F2:F6:E7
a=setup:active
a=mid:0
a=extmap:1 urn:ietf:params:rtp-hdrext:ssrc-audio-level
a=extmap:2 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time
a=extmap:3 http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01
a=extmap:4 urn:ietf:params:rtp-hdrext:sdes:mid
a=sendrecv
a=msid:f3226065-a354-4e14-a1ad-12c306d9e0b0 ac67bd67-4fee-4f38-8731-fe7bb514a1c6
a=rtcp-mux
a=rtpmap:111 opus/48000/2
a=rtcp-fb:111 transport-cc
a=fmtp:111 minptime=10;useinbandfec=1
a=rtpmap:9 G722/8000
a=rtpmap:0 PCMU/8000
a=rtpmap:8 PCMA/8000
a=rtpmap:13 CN/8000
a=rtpmap:110 telephone-event/48000
a=rtpmap:126 telephone-event/8000
a=ssrc:4220656486 cname:YbOqX8HYxv84VYue
```

**SDP Analysis:**
- **Type**: Answer (to browser)
- **Length**: 1135 characters
- **Media Sections**: 1 (audio)
- **ICE Candidates**: 0 (trickle ICE)
- **Codecs**: opus/48000/2, G722/8000, PCMU/8000, PCMA/8000, CN/8000, telephone-event/48000, telephone-event/8000
- **Setup**: active (server is active)
- **Direction**: sendrecv (bidirectional)

### WhatsApp SDP Answer (Generated by Server)
```
v=0
o=- 2377175227902901771 2 IN IP4 127.0.0.1
s=-
t=0 0
a=group:BUNDLE audio
a=msid-semantic: WMS e77ab023-4250-45be-b3d7-7db34c41c00b
m=audio 9 UDP/TLS/RTP/SAVPF 111 126
c=IN IP4 0.0.0.0
a=rtcp:9 IN IP4 0.0.0.0
a=ice-ufrag:p3nn
a=ice-pwd:OaTIYZ51L4eyUf0VNMutEEIZ
a=ice-options:trickle
a=fingerprint:sha-256 F2:C7:C2:98:3A:DA:7A:AE:E9:0D:9E:F6:56:3A:95:1C:C4:00:C6:6B:EF:33:87:40:9F:1D:82:E2:AB:A0:D4:D8
a=setup:active
a=mid:audio
a=sendrecv
a=msid:e77ab023-4250-45be-b3d7-7db34c41c00b 7e92ed4d-88b6-4f58-b0de-6dc66c671b2d
a=rtcp-mux
a=rtpmap:111 opus/48000/2
a=rtcp-fb:111 transport-cc
a=fmtp:111 minptime=10;useinbandfec=1
a=rtpmap:126 telephone-event/8000
a=ssrc:1615897061 cname:Rcp97UdPg8LR7MWp
```

**SDP Analysis:**
- **Type**: Answer (to WhatsApp)
- **Length**: 724 characters
- **Media Sections**: 1 (audio)
- **ICE Candidates**: 0 (trickle ICE)
- **Codecs**: opus/48000/2, telephone-event/8000
- **Setup**: active (server is active)
- **Direction**: sendrecv (bidirectional)

## üîÑ WebRTC Bridge Flow

### 1. Server Setup
```
1. Create browser peer connection
2. Create WhatsApp peer connection
3. Set browser SDP offer as remote description
4. Set WhatsApp SDP offer as remote description
```

### 2. Audio Track Forwarding
```
1. Forward browser audio tracks to WhatsApp peer connection
2. Wait for WhatsApp audio track
3. Forward WhatsApp audio tracks to browser peer connection
```

### 3. SDP Answer Generation
```
1. Create browser SDP answer
2. Set browser local description
3. Send browser SDP answer to browser
4. Create WhatsApp SDP answer
5. Set WhatsApp local description
6. Send WhatsApp SDP answer to WhatsApp (pre_accept + accept)
```

## üéµ Voice Exchange

### Audio Flow
```
Browser Microphone ‚Üí Browser Peer Connection ‚Üí WhatsApp Peer Connection ‚Üí WhatsApp
WhatsApp ‚Üí WhatsApp Peer Connection ‚Üí Browser Peer Connection ‚Üí Browser Speakers
```

### Codec Negotiation
- **Primary Codec**: opus/48000/2 (high quality audio)
- **Fallback Codecs**: G722/8000, PCMU/8000, PCMA/8000
- **DTMF**: telephone-event/8000 (for touch-tone)

## üîß Technical Details

### ICE (Interactive Connectivity Establishment)
- **STUN Server**: stun:stun.relay.metered.ca:80
- **Trickle ICE**: Enabled for faster connection
- **ICE Candidates**: Exchanged via Socket.IO

### DTLS (Datagram Transport Layer Security)
- **Fingerprint**: SHA-256 for security verification
- **Setup**: active/passive negotiation
- **SRTP**: Secure Real-time Transport Protocol

### Media Streams
- **Audio Only**: No video support
- **Bidirectional**: sendrecv for both directions
- **Quality**: High-quality opus codec

## ‚úÖ Success Indicators

### Server Logs
```
‚úÖ WhatsApp offer SDP stored from connect event
‚úÖ Browser offer received for INCOMING call
‚úÖ Both browser offer and WhatsApp answer available
‚úÖ Starting WebRTC bridge for incoming call
‚úÖ Audio track received from browser
‚úÖ Audio track received from WhatsApp
‚úÖ Forwarded browser audio to WhatsApp
‚úÖ Forwarded WhatsApp audio to browser
‚úÖ Successfully sent 'pre_accept' to WhatsApp
‚úÖ Successfully sent 'accept' to WhatsApp
‚úÖ WebRTC bridge completed
```

### Browser Console
```
‚úÖ Microphone access granted
‚úÖ WebRTC peer connection established
‚úÖ Audio tracks added successfully
‚úÖ ICE candidates exchanged
‚úÖ SDP answer received from server
‚úÖ Voice exchange active
```

## üö® Error Handling

### Common Issues
1. **Microphone Access Denied**: User must grant microphone permission
2. **ICE Connection Failed**: Network connectivity issues
3. **SDP Parsing Errors**: Malformed SDP from WhatsApp
4. **WebRTC State Errors**: Incorrect peer connection state management

### Debugging Steps
1. Check browser console for WebRTC errors
2. Verify microphone permissions
3. Monitor ICE candidate exchange
4. Check server logs for SDP processing
5. Verify WhatsApp API responses

## üìä Performance Metrics

### Call Quality
- **Audio Codec**: opus/48000/2 (high quality)
- **Latency**: < 100ms (target)
- **Packet Loss**: < 1% (target)
- **Jitter**: < 20ms (target)

### Connection Time
- **WebRTC Setup**: ~2-3 seconds
- **ICE Connection**: ~1-2 seconds
- **Audio Exchange**: Immediate after connection

## üîê Security Considerations

### DTLS-SRTP
- **Encryption**: All audio encrypted in transit
- **Authentication**: Fingerprint verification
- **Key Exchange**: DTLS handshake

### Network Security
- **STUN/TURN**: NAT traversal with security
- **ICE**: Secure candidate exchange
- **WebRTC**: Built-in security features

---

*This document covers the complete incoming call flow with all SDP exchanges and technical details for successful voice communication between WhatsApp and browser clients.* 