<!DOCTYPE html>
<html>
<head>
    <title>Browser SDP Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
        .analysis { background: #e8f4f8; padding: 10px; margin: 10px 0; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>Browser SDP Generation Test</h1>
    <p>This page tests different ways of generating SDP offers to see which produces <code>sendrecv</code> vs <code>recvonly</code></p>

    <div class="test-section">
        <h3>Test 1: Basic Peer Connection (No Media)</h3>
        <button onclick="testBasicPC()">Generate SDP - No Media</button>
        <div id="test1-result"></div>
    </div>

    <div class="test-section">
        <h3>Test 2: With Audio Transceiver (sendrecv)</h3>
        <button onclick="testWithTransceiver()">Generate SDP - With Transceiver</button>
        <div id="test2-result"></div>
    </div>

    <div class="test-section">
        <h3>Test 3: With User Media First, Then Offer</h3>
        <button onclick="testWithUserMedia()">Generate SDP - With User Media</button>
        <div id="test3-result"></div>
    </div>

    <div class="test-section">
        <h3>Test 4: Exact Outgoing.js Flow Simulation</h3>
        <button onclick="testOutgoingFlow()">Generate SDP - Outgoing Flow</button>
        <div id="test4-result"></div>
    </div>

    <div class="test-section">
        <h3>Test 5: Fixed Flow (Transceiver + User Media)</h3>
        <button onclick="testFixedFlow()">Generate SDP - Fixed Flow</button>
        <div id="test5-result"></div>
    </div>

    <script>
        async function sendSDPTest(sdp, description) {
            try {
                const response = await fetch('/test-browser-sdp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sdp, description })
                });
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Error sending SDP test:', error);
                return { success: false, error: error.message };
            }
        }

        function displayResult(elementId, result, sdp) {
            const element = document.getElementById(elementId);
            let html = '';
            
            if (result.success) {
                const analysis = result.analysis;
                html += `<div class="analysis">`;
                html += `<strong>Analysis:</strong><br>`;
                html += `Type: ${analysis.type}<br>`;
                html += `Length: ${analysis.length} chars<br>`;
                html += `Media Sections: ${analysis.mediaCount}<br>`;
                
                if (analysis.hasSendRecv) {
                    html += `<span class="success">✅ Has sendrecv - GOOD!</span><br>`;
                } else if (analysis.hasRecvOnly) {
                    html += `<span class="error">❌ Has recvonly - ISSUE!</span><br>`;
                } else {
                    html += `<span class="warning">⚠️ No direction specified</span><br>`;
                }
                
                html += `</div>`;
                
                // Show first few lines of SDP
                if (sdp && sdp.sdp) {
                    const lines = sdp.sdp.split('\r\n').slice(0, 20);
                    html += `<pre>${lines.join('\n')}${lines.length < sdp.sdp.split('\r\n').length ? '\n...(truncated)' : ''}</pre>`;
                }
            } else {
                html += `<span class="error">Error: ${result.error}</span>`;
            }
            
            element.innerHTML = html;
        }

        async function testBasicPC() {
            console.log('=== Test 1: Basic PC ===');
            const pc = new RTCPeerConnection();
            
            try {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
                const result = await sendSDPTest(offer, 'Test 1: Basic PC - No Media');
                displayResult('test1-result', result, offer);
                
                pc.close();
            } catch (error) {
                document.getElementById('test1-result').innerHTML = `<span class="error">Error: ${error.message}</span>`;
            }
        }

        async function testWithTransceiver() {
            console.log('=== Test 2: With Transceiver ===');
            const pc = new RTCPeerConnection();
            
            try {
                // Add transceiver BEFORE creating offer
                pc.addTransceiver('audio', { direction: 'sendrecv' });
                
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
                const result = await sendSDPTest(offer, 'Test 2: With Audio Transceiver (sendrecv)');
                displayResult('test2-result', result, offer);
                
                pc.close();
            } catch (error) {
                document.getElementById('test2-result').innerHTML = `<span class="error">Error: ${error.message}</span>`;
            }
        }

        async function testWithUserMedia() {
            console.log('=== Test 3: With User Media ===');
            const pc = new RTCPeerConnection();
            
            try {
                // Get user media FIRST
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Add tracks
                stream.getTracks().forEach(track => {
                    pc.addTrack(track, stream);
                });
                
                // Then create offer
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
                const result = await sendSDPTest(offer, 'Test 3: User Media First, Then Offer');
                displayResult('test3-result', result, offer);
                
                // Cleanup
                stream.getTracks().forEach(track => track.stop());
                pc.close();
            } catch (error) {
                document.getElementById('test3-result').innerHTML = `<span class="error">Error: ${error.message}</span>`;
            }
        }

        async function testOutgoingFlow() {
            console.log('=== Test 4: Outgoing Flow Simulation ===');
            const pc = new RTCPeerConnection();
            
            try {
                // This simulates the exact flow in outgoing.js
                
                // 1. Add transceiver (like we do in browser)
                pc.addTransceiver('audio', { direction: 'sendrecv' });
                
                // 2. Get user media
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // 3. Add tracks
                stream.getTracks().forEach(track => {
                    pc.addTrack(track, stream);
                });
                
                // 4. Create offer (this is what browser sends to server)
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
                const result = await sendSDPTest(offer, 'Test 4: Outgoing.js Flow Simulation');
                displayResult('test4-result', result, offer);
                
                // Cleanup
                stream.getTracks().forEach(track => track.stop());
                pc.close();
            } catch (error) {
                document.getElementById('test4-result').innerHTML = `<span class="error">Error: ${error.message}</span>`;
            }
        }

        async function testFixedFlow() {
            console.log('=== Test 5: Fixed Flow ===');
            const pc = new RTCPeerConnection();
            
            try {
                // Get user media FIRST (before transceiver)
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Add tracks FIRST
                stream.getTracks().forEach(track => {
                    pc.addTrack(track, stream);
                });
                
                // Add transceiver AFTER tracks (this might be the issue)
                pc.addTransceiver('audio', { direction: 'sendrecv' });
                
                // Create offer
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
                const result = await sendSDPTest(offer, 'Test 5: Fixed Flow (Media First, Then Transceiver)');
                displayResult('test5-result', result, offer);
                
                // Cleanup
                stream.getTracks().forEach(track => track.stop());
                pc.close();
            } catch (error) {
                document.getElementById('test5-result').innerHTML = `<span class="error">Error: ${error.message}</span>`;
            }
        }
    </script>
</body>
</html> 